<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gr√°ficos - IoT Monitor</title>
    <!-- Importando Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Mesmas Vari√°veis do Dashboard Principal --- */
        :root {
            --bg-color: #f3f3f3;
            --card-bg: #ffffff;
            --text-primary: #1d1d1d;
            --text-secondary: #606060;
            --accent-color: #0067c0;
            --border-color: #e5e5e5;
            --shadow-card: 0 2px 4px rgba(0, 0, 0, 0.04);
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "Segoe UI Variable", "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 250px;
            background-color: var(--bg-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .app-title { font-size: 18px; font-weight: 600; margin-bottom: 30px; display: flex; gap: 10px; }

        .nav-item {
            padding: 10px 16px; margin-bottom: 4px; border-radius: 4px; cursor: pointer;
            color: var(--text-primary); font-size: 14px; display: flex; align-items: center; gap: 12px;
            transition: background 0.2s; text-decoration: none; /* Link reset */
        }
        .nav-item:hover { background-color: rgba(0, 0, 0, 0.04); }
        
        /* Classe Active para marcar p√°gina atual */
        .nav-item.active {
            background-color: #ffffff; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;
        }
        .nav-item.active::before {
            content: ''; position: absolute; left: 4px; top: 12px; bottom: 12px; width: 3px;
            background-color: var(--accent-color); border-radius: 2px;
        }

        /* --- Conte√∫do --- */
        .main-content { flex: 1; padding: 24px 32px; overflow-y: auto; }
        
        header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .subtitle { color: var(--text-secondary); font-size: 14px; }

        /* --- Layout dos Gr√°ficos (Grid) --- */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Coluna esquerda larga, direita estreita */
            grid-template-rows: auto auto;
            gap: 20px;
            padding-bottom: 40px;
        }

        .chart-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
        }

        .chart-card.full-width { grid-column: 1 / -1; } /* Ocupa toda largura */
        .chart-card.tall { min-height: 300px; }

        .card-title {
            font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);
        }

        /* Responsividade para telas menores */
        @media (max-width: 1000px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        .refresh-btn {
            background-color: var(--bg-color); border: 1px solid var(--border-color);
            border-radius: 4px; padding: 6px 12px; font-size: 13px; cursor: pointer;
            font-family: inherit; transition: all 0.2s;
        }
        .refresh-btn:hover { background-color: #e9e9e9; }

    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="app-title"><span>üì° IoT Monitor</span></div>
        
        <!-- Links de Navega√ß√£o (Apontam para os arquivos) -->
        <a href="dashboard.html" class="nav-item">
            <span>üìä Dashboard (Lista)</span>
        </a>
        <div class="nav-item active">
            <span>üìà Gr√°ficos (Analytics)</span>
        </div>
        <div class="nav-item">
            <span>‚öôÔ∏è Configura√ß√µes</span>
        </div>
    </div>

    <!-- Conte√∫do -->
    <div class="main-content">
        <header>
            <div>
                <h1>Visualiza√ß√£o de Dados</h1>
                <p class="subtitle">Tend√™ncias e m√©tricas em tempo real</p>
            </div>
            <button class="refresh-btn" onclick="updateCharts()">For√ßar Atualiza√ß√£o</button>
        </header>

        <div class="charts-grid">
            
            <!-- Gr√°fico 1: Linha do Tempo (Temp & Umidade) -->
            <div class="chart-card full-width tall">
                <div class="card-title">üå°Ô∏è Monitoramento Ambiental (Tempo Real)</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="envChart"></canvas>
                </div>
            </div>

            <!-- Gr√°fico 2: Rosca (Luz) -->
            <div class="chart-card">
                <div class="card-title">üí° Intensidade de Luz Atual</div>
                <div style="position: relative; height: 200px; display: flex; justify-content: center;">
                    <canvas id="lightChart"></canvas>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 24px; font-weight: 300;" id="lightValueDisplay">--</div>
            </div>

            <!-- Gr√°fico 3: Barras (√Çngulo/Movimento) -->
            <div class="chart-card">
                <div class="card-title">ü§ñ Hist√≥rico de Movimento (Servo)</div>
                <div style="position: relative; height: 200px; width: 100%;">
                    <canvas id="angleChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configura√ß√µes Globais do Chart.js para estilo WinUI
        Chart.defaults.font.family = '"Segoe UI Variable", "Segoe UI", sans-serif';
        Chart.defaults.color = '#606060';
        
        const API_URL = "http://localhost:5000/api/sensor-data";
        
        // Vari√°veis para armazenar as inst√¢ncias dos gr√°ficos
        let envChartInstance = null;
        let lightChartInstance = null;
        let angleChartInstance = null;

        // --- 1. Inicializar Gr√°ficos Vazios ---
        function initCharts() {
            // Gr√°fico de Linha (Ambiente)
            const ctxEnv = document.getElementById('envChart').getContext('2d');
            envChartInstance = new Chart(ctxEnv, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: false, grid: { color: '#f0f0f0' } }
                    },
                    plugins: { legend: { position: 'top', align: 'end' } }
                }
            });

            // Gr√°fico de Rosca (Luz)
            const ctxLight = document.getElementById('lightChart').getContext('2d');
            lightChartInstance = new Chart(ctxLight, {
                type: 'doughnut',
                data: {
                    labels: ['Luz', 'Restante'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#fcd116', '#e5e5e5'],
                        borderWidth: 0,
                        cutout: '75%' // Espessura da rosca
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            // Gr√°fico de Barra (√Çngulo)
            const ctxAngle = document.getElementById('angleChart').getContext('2d');
            angleChartInstance = new Chart(ctxAngle, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 20, min: -20, grid: { display: false } },
                        x: { display: false } // Oculta labels do eixo X para ficar limpo
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 2. Buscar e Processar Dados ---
        async function updateCharts() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Erro na API");
                
                const rawData = await response.json();
                
                // A API retorna do mais novo para o mais antigo. 
                // Para gr√°ficos de tempo, precisamos inverter (antigo -> novo).
                const data = rawData.reverse(); 

                // Arrays para preencher os gr√°ficos
                const timestamps = [];
                const temps = [];
                const hums = [];
                const angles = [];
                let currentLight = 0;

                // Processamento dos dados
                data.forEach(item => {
                    const tipo = (item.tipo_sensor || '').toLowerCase();
                    const hora = item.timestamp ? item.timestamp.split(' ')[1] : '-'; // Pega s√≥ a hora

                    if (tipo.includes('temp')) {
                        timestamps.push(hora); // Usamos o tempo da temperatura como base eixo X
                        temps.push(item.valor);
                    }
                    else if (tipo.includes('umid') || tipo.includes('humid')) {
                        hums.push(item.valor);
                    }
                    else if (tipo.includes('ang') || tipo.includes('tilt')) {
                        angles.push(item.valor);
                    }
                    else if (tipo.includes('lum') || tipo.includes('light')) {
                        currentLight = item.valor; // Pega sempre o √∫ltimo do loop (que √© o mais recente devido ao reverse?? N√£o, reverse coloca o mais recente no fim)
                    }
                });

                // --- Atualizar Gr√°fico Ambiental ---
                // Sincroniza√ß√£o simples: Assumindo que temp e umid chegam juntos.
                // Se os arrays tiverem tamanhos diferentes, ChartJS lida bem, mas idealmente timestamps deveriam ser unificados.
                envChartInstance.data.labels = timestamps;
                envChartInstance.data.datasets = [
                    {
                        label: 'Temperatura (¬∞C)',
                        data: temps,
                        borderColor: '#d9534f', // Vermelho suave
                        backgroundColor: 'rgba(217, 83, 79, 0.1)',
                        tension: 0.4, // Curva suave
                        fill: true
                    },
                    {
                        label: 'Umidade (%)',
                        data: hums,
                        borderColor: '#5bc0de', // Azul suave
                        backgroundColor: 'rgba(91, 192, 222, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ];
                envChartInstance.update();

                // --- Atualizar Gr√°fico de Luz ---
                // Normaliza luz (assumindo max 1000 lux para o gr√°fico ficar bonito, ajuste conforme seu sensor)
                const maxLight = 1000; 
                const lightPercent = Math.min(currentLight, maxLight);
                
                lightChartInstance.data.datasets[0].data = [lightPercent, maxLight - lightPercent];
                lightChartInstance.update();
                document.getElementById('lightValueDisplay').innerText = currentLight + " Lux";

                // --- Atualizar Gr√°fico de √Çngulo ---
                // Pega apenas os √∫ltimos 10 movimentos para n√£o poluir
                const lastAngles = angles.slice(-10);
                angleChartInstance.data.labels = lastAngles.map((_, i) => i); // Labels dummy
                angleChartInstance.data.datasets = [{
                    label: '√Çngulo Servo',
                    data: lastAngles,
                    backgroundColor: lastAngles.map(a => a >= 0 ? '#5cb85c' : '#f0ad4e'), // Verde se positivo, Laranja se negativo
                    borderRadius: 4
                }];
                angleChartInstance.update();

            } catch (error) {
                console.error("Erro ao atualizar gr√°ficos:", error);
            }
        }

        // --- Inicializa√ß√£o ---
        window.onload = () => {
            initCharts();
            updateCharts();
            setInterval(updateCharts, 2000); // Atualiza a cada 2 segundos
        };

    </script>
</body>
</html>